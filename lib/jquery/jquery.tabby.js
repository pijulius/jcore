(function(h){h.fn.tabby=function(m){var p=h.extend({},h.fn.tabby.defaults,m),l=h.fn.tabby.pressed;return this.each(function(){$this=h(this);var b=h.meta?h.extend({},p,$this.data()):p;$this.bind("keydown",function(a){var m=h.fn.tabby.catch_kc(a);if(16==m)l.shft=true;if(17==m)l.ctrl=true,setTimeout("$.fn.tabby.pressed.ctrl = false;",1E3);if(18==m)l.alt=true,setTimeout("$.fn.tabby.pressed.alt = false;",1E3);if(9==m&&!l.ctrl&&!l.alt){l.last=m;setTimeout("$.fn.tabby.pressed.last = null;",0);var a=h(a.target).get(0),
i=l.shft,m=a.scrollTop;if(a.setSelectionRange){var d=a.selectionStart,j=a.selectionEnd;if(d==j)if(i)if("\t"==a.value.substring(d-b.tabString.length,d))a.value=a.value.substring(0,d-b.tabString.length)+a.value.substring(d),a.focus(),a.setSelectionRange(d-b.tabString.length,d-b.tabString.length);else{if("\t"==a.value.substring(d,d+b.tabString.length))a.value=a.value.substring(0,d)+a.value.substring(d+b.tabString.length),a.focus(),a.setSelectionRange(d,d)}else a.value=a.value.substring(0,d)+b.tabString+
a.value.substring(d),a.focus(),a.setSelectionRange(d+b.tabString.length,d+b.tabString.length);else{var e=a.value.split("\n"),f=[],g=0,k=0,c;for(c in e)k=g+e[c].length,f.push({start:g,end:k,selected:g<=d&&k>d||k>=j&&g<j||g>d&&k<j}),g=k+1;e=0;for(c in f)if(f[c].selected)if(g=f[c].start+e,i&&b.tabString==a.value.substring(g,g+b.tabString.length))a.value=a.value.substring(0,g)+a.value.substring(g+b.tabString.length),e-=b.tabString.length;else if(!i)a.value=a.value.substring(0,g)+b.tabString+a.value.substring(g),
e+=b.tabString.length;a.focus();a.setSelectionRange(d+(e>0?b.tabString.length:e<0?-b.tabString.length:0),j+e)}}else if(document.selection&&(c=document.selection.createRange(),a==c.parentElement()))if(""==c.text){if(i){i=c.getBookmark();c.moveStart("character",-b.tabString.length);if(b.tabString==c.text)c.text="";else if(c.moveToBookmark(i),c.moveEnd("character",b.tabString.length),b.tabString==c.text)c.text="";c.collapse(true)}else c.text=b.tabString,c.collapse(false);c.select()}else{j=c.text;d=j.length;
f=j.split("\r\n");j=document.body.createTextRange();j.moveToElementText(a);j.setEndPoint("EndToStart",c);g=j.text;e=g.split("\r\n");g=g.length;k=document.body.createTextRange();k.moveToElementText(a);k.setEndPoint("StartToEnd",c);var k=k.text,o=document.body.createTextRange();o.moveToElementText(a);o.setEndPoint("StartToEnd",j);var n=o.text,o=h(a).html();h("#r3").text(g+" + "+d+" + "+k.length+" = "+o.length);g+n.length<o.length?(e.push(""),g+=2,i&&b.tabString==f[0].substring(0,b.tabString.length)?
f[0]=f[0].substring(b.tabString.length):i||(f[0]=b.tabString+f[0])):i&&b.tabString==e[e.length-1].substring(0,b.tabString.length)?e[e.length-1]=e[e.length-1].substring(b.tabString.length):i||(e[e.length-1]=b.tabString+e[e.length-1]);for(n=1;n<f.length;n++)i&&b.tabString==f[n].substring(0,b.tabString.length)?f[n]=f[n].substring(b.tabString.length):i||(f[n]=b.tabString+f[n]);1==e.length&&0==g&&(i&&b.tabString==f[0].substring(0,b.tabString.length)?f[0]=f[0].substring(b.tabString.length):i||(f[0]=b.tabString+
f[0]));g+d+k.length<o.length&&f.push("");j.text=e.join("\r\n");c.text=f.join("\r\n");i=document.body.createTextRange();i.moveToElementText(a);0<g?i.setEndPoint("StartToEnd",j):i.setEndPoint("StartToStart",j);i.setEndPoint("EndToEnd",c);i.select()}a.scrollTop=m;return false}}).bind("keyup",function(a){if(16==h.fn.tabby.catch_kc(a))l.shft=false}).bind("blur",function(a){9==l.last&&h(a.target).one("focus",function(){l.last=null}).get(0).focus()})})};h.fn.tabby.catch_kc=function(h){return h.keyCode?h.keyCode:
h.charCode?h.charCode:h.which};h.fn.tabby.pressed={shft:false,ctrl:false,alt:false,last:null};h.fn.tabby.defaults={tabString:String.fromCharCode(9)}})(jQuery);
